í•„ë… ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ ì•ˆë‚´
https://www.notion.so/1c0caf5650aa811c988dd83de237658c

ë°±ì—”ë“œ API ê°€ì´ë“œ
https://docs.google.com/spreadsheets/d/1qL__Ming4UcAr9EQb5MLC2v21x27RD4-NK3XknnVmuI/edit?gid=0#gid=0

[1ë‹¨ê³„] ê¹ƒë¦¬íŒŒì§“í† ë¦¬ ìƒì„±, ì¥ê³  í”„ë¡œì íŠ¸ ìƒì„±, PostgresDBì—°ê²°
https://www.notion.so/1-1c2caf5650aa808eb4f5c87fe12964e7
[2ë‹¨ê³„] ERD ì„¤ê³„ì™€ Model ìƒì„±
https://www.notion.so/2-1c2caf5650aa8066a17acaf8d4d70b20
[3ë‹¨ê³„] ìœ ì € í”Œë¡œìš° ì°¨íŠ¸ ì„¤ê³„ ë° ìœ ì € API êµ¬í˜„
https://www.notion.so/3-1c2caf5650aa808fba55d686a2c9e5aa
[4ë‹¨ê³„] ê³„ì¢Œ, ê±°ë˜ API êµ¬í˜„
https://www.notion.so/4-1c2caf5650aa80cbbb82c2b4b73132c6
[5ë‹¨ê³„] ë¶„ì„(Analysis) API êµ¬í˜„
https://www.notion.so/5-1c2caf5650aa809ba62ce9488ca62df1
[6ë‹¨ê³„] Django Signalì„ ì´ìš©í•œ ì•Œë¦¼ êµ¬í˜„
https://www.notion.so/6-1c2caf5650aa80f3b565e5a4f6882876
[7ë‹¨ê³„] AWS Cloud Service ë¥¼ ì´ìš©í•´ì„œ ë°°í¬
https://www.notion.so/7-1c2caf5650aa806ba040f5af5cf08ce4

poetry init

ë¼ì´ë¸ŒëŸ¬ë¦¬ ì œê±°
poetry remove ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„

[tool.poetry.dependencies] ì—ëŠ” ë°°í¬ í™˜ê²½ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜
poetry add ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„

[tool.poetry.group.dev.dependencies] ì— ê°œë°œí™˜ê²½ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
poetry add -G dev ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„

íŒ€ì›ì´ í•´ì•¼í•  ì¼

poetryê°€ ìƒì„±í•œ pyproject.tomlì— ì‘ì„±ëœ dependenciesëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
poetry install --no-root
ê°€ìƒí™˜ê²½ ì—†ìœ¼ë©´ ê°€ìƒí™˜ê²½ì„ ìë™ìƒì„±í•¨. ê¸°ë³¸ì„¤ì • : ì „ì—­ìœ„ì¹˜ì— ê°€ìƒí™”ê²½ ìƒì„±
í˜¹ì€ ê°€ìƒí™˜ê²½ì„ ë¯¸ë¦¬ ë§Œë“  ìƒíƒœì—ì„  ê°€ìƒí™˜ê²½ì— ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜

ì „ì—­ ê°€ìƒí™˜ê²½ ìœ„ì¹˜ í™•ì¸
poetry env info --path

ì „ì—­ ê°€ìƒí™˜ê²½ ì œê±°
poetry env remove python

ê°€ìƒí™˜ê²½ ìƒì„±
python3 -m venv .venv

ì„¤ì • íŒŒì¼ ìƒì„±
django-admin startproject config .

ì•± ë§Œë“¤ê¸°
python3 manage.py startapp ì•±ì´ë¦„

postgresql db ì„¤ì¹˜
brew install postgresql

PostgreSQL ì„œë²„ ì‹¤í–‰
brew services start postgresql

ì‹¤í–‰ í™•ì¸
brew services

PostgreSQL ì„¤ì¹˜ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì¸ postgresì— ì ‘ì†
psql postgres

ìœ ì € í™•ì¸
ë³¸ì¸ì˜ ë§¥ ìœ ì € ì´ë¦„ í˜¹ì€ postgresë¼ëŠ” ìœ ì €ê°€ ìˆì–´ì•¼ ì •ìƒ
\du

ìƒˆë¡œìš´ ìœ ì €ë¥¼ ìƒì„±
CREATE USER ìœ ì €ì´ë¦„

ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
ALTER USER root WITH PASSWORD 'ë¹„ë°€ë²ˆí˜¸';

ê¶Œí•œ ì„¤ì •
ALTER USER root WITH SUPERUSER;

ìœ ì € ë‹¤ì‹œ í™•ì¸
\du

db ìƒì„±
CREATE DATABASE ë°ì´í„°ë² ì´ìŠ¤ì´ë¦„;

db ëª©ë¡ í™•ì¸
\l


ìƒˆë¡œ ìƒì„±ëœ ìœ ì € í˜¹ì€ ê¸°ë³¸ ìœ ì €ë¥¼ í™œìš©í•˜ì—¬ ìƒì„±ëœ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì ‘ì†
psql ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
ë˜ëŠ”
psql -U ìœ ì €ì´ë¦„ -d ë°ì´í„°ë² ì´ìŠ¤ì´ë¦„ -W
(Wì˜µì…˜ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ì ‘ì†í•˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤. í•„ìˆ˜ëŠ” ì•„ë‹˜)

í…Œì´ë¸” ë‚´ì—­ì„ ì¡°íšŒ
\dt

PostgreSQLì„ Djangoì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ í•„ìš”í•œ psycopg ì„¤ì¹˜
poetry add psycopg2-binary

ln -sf dev.py settings.py
ln -sf prod.py settings.py

ln -sf urls_dev.py urls.py
ln -sf urls_prod.py urls.py


bank dbì— bankcode ë°ì´í„° ë„£ê¸°

bank db ì ‘ì†
psql bank

db.txtì— ìˆëŠ” í…Œì´ë¸” ìƒˆì„± ì¿¼ë¦¬ ì…ë ¥
INSERT INTO bank_code (code, name) VALUES
('000', 'ì•Œìˆ˜ì—†ìŒ'),
('001', 'í•œêµ­ì€í–‰'),
('002', 'ì‚°ì—…ì€í–‰'),
...

ê¹ƒ í”Œë¡œìš°
https://legend-palm-1f1.notion.site/Git-Flow-14acaf5650aa800387a7c43e334cc72e
https://legend-palm-1f1.notion.site/Git-Flow-14acaf5650aa80f2a4a9efa455e54f9b

ë§¥ì—ì„œ í™ˆë¸Œë£¨ë¡œ ê¹ƒ í”Œë¡œìš° ì„¤ì¹˜
brew install git-flow-avh

ê¹ƒ í”Œë¡œìš° ì´ˆê¸°í™”
git flow init

Branch name for production releases?
â†’ ê¸°ë³¸ê°’ì€ master ì´ì§€ë§Œ main ìœ¼ë¡œ í•˜ëŠ”ê²ƒ ì¶”ì²œ

Branch name for "next release" development?
â†’ develop (ê¸°ë³¸ê°’)

ë‚˜ë¨¸ì§€ ì—”í„°


# Feature ë¸Œëœì¹˜

ìƒì„±: ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ê°œë°œí•  ë•Œ ì‚¬ìš©
git flow feature start <ê¸°ëŠ¥ì´ë¦„>

ì™„ë£Œ: ê¸°ëŠ¥ ê°œë°œì„ ë§ˆì¹˜ê³  develop ë¸Œëœì¹˜ë¡œ ë³‘í•©
git flow feature finish <ê¸°ëŠ¥ì´ë¦„>

# Release ë¸Œëœì¹˜

ìƒì„±: ë°°í¬ ì¤€ë¹„ë¥¼ í•  ë•Œ ì‚¬ìš©
git flow release start <ë²„ì „ë²ˆí˜¸>

ì™„ë£Œ: ë¦´ë¦¬ì¦ˆ ì™„ë£Œ í›„ masterì™€ developì— ë³‘í•©
git flow release finish <ë²„ì „ë²ˆí˜¸>

# Hotfix ë¸Œëœì¹˜

ìƒì„±: ê¸´ê¸‰í•œ ë²„ê·¸ ìˆ˜ì •ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©
git flow hotfix start <ë²„ê·¸ì´ë¦„>

ì™„ë£Œ: ìˆ˜ì • ì™„ë£Œ í›„ masterì™€ developì— ë³‘í•©
git flow hotfix finish <ë²„ê·¸ì´ë¦„>


## . Git Flow ì „ì²´ íë¦„

1. íŒ€ ë¦¬ë”ê°€ new project ìƒì„±í•˜ê³  ì´ˆê¸° ì„¸íŒ…ì„ ì§„í–‰
2. íŒ€ ë¦¬ë”ê°€ github repositoryì— ì˜¬ë¦¬ê¸°
3. ë‚˜ë¨¸ì§€ íŒ€ì›ë“¤ì€ repositoryì— ì˜¬ë¼ ì˜¨ projectë¥¼ í´ë¡ ë°›ì•„ ë¡œì»¬ì— ê°€ì ¸ì˜´
4. ì „ íŒ€ì› `git flow init` (ì´ˆê¸°í™”) í•´ì¤Œ
    - ì´ˆê¸°í™” ì‹œ `Branch name for production releases?`ì§ˆë¬¸ì—
    â†’ ê¸°ë³¸ ê°’ì€ `master` ì´ì§€ë§Œ `main` ìœ¼ë¡œ ì„¤ì •í•˜ì‹œëŠ” ê²ƒì„ ì¶”ì²œ..
5. ëª¨ë“  íŒ€ì› ë¡œì»¬ í™˜ê²½ì—ì„œ `git branch` ëª…ë ¹ì–´ë¡œ ì¡´ì¬í•˜ëŠ” ë¸Œëœì¹˜ë¥¼ í™•ì¸í•´ë³´ë©´ ì²˜ìŒì—ëŠ” `main` ë¸Œëœì¹˜ ë¿ë§Œ ìˆì—ˆì§€ë§Œ ì´ˆê¸°í™” ì´í›„  `develop` ë¸Œëœì¹˜ê°€ ë¡œì»¬ì— ìƒê²¨ìˆìŒì„ í™•ì¸ê°€ëŠ¥.
6. ê°ì ë§¡ì€ ê¸°ëŠ¥ ê°œë°œì„ ìœ„í•´ `git flow feature start ê¸°ëŠ¥ì´ë¦„` ëª…ë ¹ì–´ë¡œ feature ë¸Œëœì¹˜ë¥¼ ìƒì„±
â†’ `git branch` ëª…ë ¹ì–´ë¡œ í™•ì¸í•´ë³´ë©´ `feature/ê¸°ëŠ¥ì´ë¦„` ë¸Œëœì¹˜ê°€ ìƒì„±ë˜ì–´ìˆìŒ.
7. ìƒì„±ëœ feature ë¸Œëœì¹˜ì—ì„œ ê¸°ëŠ¥ ê°œë°œ ì‘ì—…í•©ë‹ˆë‹¤.
8. ì‘ì—… ì™„ë£Œ í›„ feature ë¸Œëœì¹˜ë¥¼ ì›ê²© ì €ì¥ì†Œì— push í•´ì„œ PR ì˜¬ë¦½ë‹ˆë‹¤.
9. PR íƒ€ì´í‹€, ì„¤ëª… ë“± ì‘ì„± í›„ ë¦¬ë·°ì–´ íŒ€ì›ë“¤ ë“±ë¡í•©ë‹ˆë‹¤.
10. PR ìŠ¹ì¸ ë˜ë©´ Squash and Merge ë²„íŠ¼ì„ í†µí•´ ì••ì¶• ëœ í•˜ë‚˜ì˜ ì»¤ë°‹ìœ¼ë¡œ developì— ë¨¸ì§€í•©ë‹ˆë‹¤.
11. ê·¸ë¦¬ê³  ë¡œì»¬ í™˜ê²½ì—ì„œ `develop` ë¸Œëœì¹˜ë¡œ checkout í•˜ê³ , ê¸°ëŠ¥ ê°œë°œì‹œì— ì‚¬ìš©í–ˆë˜ ê¸°ì¡´ì˜  feature ë¸Œëœì¹˜ëŠ” ì‚­ì œí•´ì¤ë‹ˆë‹¤.
12. ê°œë°œëœ ê¸°ëŠ¥ì´ ì—…ë°ì´íŠ¸ ëœ ì›ê²© ì €ì¥ì†Œì˜ `develop` ë¸Œëœì¹˜ë¥¼ `pull` í•©ë‹ˆë‹¤.
    - `git pull origin develop` ëª…ë ¹ì–´ ì‚¬ìš©í•˜ê¸°
13. (( 7~13ë²ˆ ë¬´í•œ ë°˜ë³µ ))
14. ê° íŒ€ì›ë“¤ì´ ê¸°ëŠ¥ ê°œë°œì„ ëª¨ë‘ ì™„ë£Œí–ˆë‹¤ë©´ ë°°í¬í•  ì¤€ë¹„ë¥¼ í•´ì•¼í•©ë‹ˆë‹¤. íŒ€ì¥ì´ ë°°í¬ ê´€ë ¨ ì„¤ì •ì„ ëª¨ë‘ ì™„ë£Œí•˜ê³  `develop` ë¸Œëœì¹˜ì— ë¨¸ì§€í•©ë‹ˆë‹¤.
15. `main` ë¸Œëœì¹˜ì™€ `develop` ë¸Œëœì¹˜ë¥¼ compare & PR í•œ í›„ `merge` í•©ë‹ˆë‹¤.
16. `main` ë¸Œëœì¹˜ë¥¼ EC2 ì—ì„œ í´ë¡ ë°›ì•„ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.


.gitignore ì‹œí¬ë¦¿ í´ë” ì—…ë¡œë“œ ì œí•œ
.config_secret/

ì‹œí¬ë¦¿ í´ë” ìƒì„±
.config_secret

ì‹œí¬ë¦¿ í´ë”ì— secret.json ìƒì„±

secret.jsonì— ì…ë ¥
{
  "DJANGO_SECRET_KEY" : "django-insecure-9u=$gmlz$b8h2^d9%3x871ti9pcile_q19lif*#yw(q@#=nb!8",
  "email": {
    "user": "ì´ë©”ì¼",
    "password": "ë¹„ë°€ë²ˆí˜¸"
  },
  "DB": {
  "ENGINE": "django.db.backends.postgresql",
  "NAME": "bank",
  "USER": "root",
  "PASSWORD": "1234",
  "HOST": "localhost",
  "PORT": "5432"
  }
}

ì‹œí¬ë¦¿ íŒŒì¼ ì½ì–´ ì˜¤ê¸° ìœ„í•´ settings.pyì— ì„¤ì •

with open(BASE_DIR / '.config_secret' / 'secret.json') as f:
    config_secret_str = f.read()

SECRET = json.loads(config_secret_str)  # json í˜•íƒœë¥¼ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë°”ê¿ˆ

# Email
# from django.core.mail.backends.smtp import EmailBackend
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.naver.com' # ë„¤ì´ë²„ í™˜ê²°ì„¤ì •ì—ì„œ ë³¼ ìˆ˜ ìˆìŒ.
EMAIL_USE_TLS = True  # ë³´ì•ˆì—°ê²°
EMAIL_PORT = 587  # ë„¤ì´ë²„ ë©”ì¼ í™˜ê²½ì„¤ì •ì—ì„œ í™•ì¸ ê°€ëŠ¥
EMAIL_HOST_USER = SECRET["email"]["user"]
EMAIL_HOST_PASSWORD =  SECRET["email"]["password"]

# .config_secret í´ë” ë§Œë“¤ê³ 
# í´ë”ì— secret.json ë§Œë“¤ê³ 
# .gitignoreì— ì¶”ê°€í•œ í›„ ê´€ë¦¬
# print(SECRET['DB']['HOST'])
# print(SECRET['DB2']['HOST'])
# ì´ë ‡ê²Œ ì“¸ ìˆ˜ë„ìˆê³  dotenvë¥¼ í†µí•´ ê´€ë¦¬í•  ìˆ˜ë„ ìˆìŒ

LOGIN_URL = '/login/'
LOGOUT_REDIRECT_URL = '/login/'
# LOGOUT_REDIRECT_URL = '/'



simplejwt ì‹œì‘
https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html

simplejwt ì„¤ì¹˜
poetry add djangorestframework-simplejwt

# config/settings.py

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        ...
        'rest_framework_simplejwt.authentication.JWTAuthentication',
        ...
    ]
}
INSTALLED_APPS = [
    ...
    'rest_framework_simplejwt',
    ...
]

# config/urls.py

urlpatterns = [
    ...
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('api/token/verify/', TokenVerifyView.as_view(), name='token_verify'),
    ...
]

simplejwt ì„¸íŒ…
https://django-rest-framework-simplejwt.readthedocs.io/en/latest/settings.html#


simplejwt ì»¤ìŠ¤í„° ë§ˆì´ì§•
https://django-rest-framework-simplejwt.readthedocs.io/en/latest/customizing_token_claims.html

# utils/jwt_serializers.py

from rest_framework_simplejwt.serializers import TokenObtainPairSerializer
from rest_framework_simplejwt.views import TokenObtainPairView

class MyTokenObtainPairSerializer(TokenObtainPairSerializer):
    @classmethod
    def get_token(cls, user):
        token = super().get_token(user)

        # Add custom claims
        token['user_name'] = user.username  # í† í°ì— ìœ ì € ì´ë¦„ì„ í•¨ê»˜ ë‹´ì•„ì„œ ë³´ëƒ„

        return token

# config/settings.py
# JWT ì„¤ì •
SIMPLE_JWT = {
  # It will work instead of the default serializer(TokenObtainPairSerializer).
  "TOKEN_OBTAIN_SERIALIZER": "utils.jwt_serializers.MyTokenObtainPairSerializer",
  # ...
}

í† í° ì •ë³´ ë³´ëŠ” ë²•
https://jwt.io/

í† í° ë§Œë£Œì‹œê°„ ìˆ˜ì •
# JWT ì„¤ì •
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(minutes=30),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=1),
    # It will work instead of the default serializer(TokenObtainPairSerializer).
    "TOKEN_OBTAIN_SERIALIZER": "utils.jwt_serializers.MyTokenObtainPairSerializer",
    # ...
}

poetry add -G dev django-extensions
poetry add -G dev ipython

poetry.lock ì—…ë°ì´íŠ¸
poetry lock


ê°œë°œí™˜ê²½ìœ¼ë¡œ ê°€ìƒí™˜ê²½ì— ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
poetry install --with dev --no-root

ë¡œê·¸ì•„ì›ƒ êµ¬í˜„
INSTALLED_APPS = [
    ...
    'rest_framework_simplejwt.token_blacklist',
]

# JWT ì„¤ì •
SIMPLE_JWT = {
    "BLACKLIST_AFTER_ROTATION": True,
    "ROTATE_REFRESH_TOKENS": True,
}

python manage.py migrate

--------------------
ì´ë©”ì¼ ë³´ë‚´ëŠ” ê¸°ëŠ¥ ë¬¸ì œ
--------------------

DEBUG=Falseì¼ ë•Œ ì´ë©”ì¼ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì— ë¬¸ì œìƒê¸´ë‹¤ë©´.

from django.core.mail import send_mail
send_mail í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ë•Œ ë¬¸ì œê°€ ìƒê¸´ë‹¤ë©´

try:
    send_mail(subject, message, settings.EMAIL_HOST_USER, to_email)
except Exception as e:
    print(repr(e))
    raise

ì´ë ‡ê²Œ í•´ì„œ ì‹¤íŒ¨ í–ˆì„ ë•Œ ì›ì¸ì„ ì˜¤ë¥˜ ì½”ë“œë¡œ íŒŒì•…í•œë‹¤.

ì›ì¸ì€
SSLCertVerificationError(1, '[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: self-signed certificate in certificate chain (_ssl.c:1018)')
ì¸ì¦ì„œë¥¼ ì°¾ì§€ ëª»í•´ì„œ ì˜¤ë¥˜ê°€ ë‚¬ë‹¤ëŠ” ë§ì¸ë°

íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ certifi ì„¤ì¹˜ í›„
ì¸ì¦ì„œë¥¼ ê°•ì œë¡œ ì¸ì‹ ê°€ëŠ¥í•˜ê²Œ certifië¡œ ì„¤ì •í•˜ë©´ ì–´ë– í•œ ê²½ìš°ì—ë„ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.
ì¸ì¦ì„œ ê²½ë¡œë¥¼ ì¸ì‹ëª»í•˜ë“  ì¸ì¦ì„œê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ì§€ ì•Šë“  ì¸ì‹.

í„°ë¯¸ë„ì— ì…ë ¥í•´ì„œ ì¼ì‹œì ìœ¼ë¡œ í•´ê²°í•˜ëŠ” ë°©ë²•
export SSL_CERT_FILE=$(python -m certifi)

í•´ê²°ë°©ë²•1
í„°ë¯¸ë„ì— ì˜êµ¬ ì ìš©

vim ~/.zshrc
ë§¨ ì•„ë« ì¤„ì— ì¶”ê°€
export SSL_CERT_FILE=$(python -m certifi)

í•´ê²°ë°©ë²•2
ê°€ìƒí™˜ê²½ì´ í™œì„±í™” ë ë•Œë§ˆë‹¤ ì¸ì¦ì„œ ê²½ë¡œë¥¼ ìë™ ì§€ì •í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•œë‹¤.

activateìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •
vim .venv/bin/activate
ë§¨ ì•„ë«ì¤„ì— ì¶”ê°€
export SSL_CERT_FILE=$(python -m certifi)

í•´ê²°ë°©ë²•3 (ê°€ì¥ ì¶”ì²œ)
í”„ë¡œì íŠ¸ê°€ ì¸ì¦ì„œ ê²½ë¡œë¥¼ ì¸ì‹í•  ìˆ˜ ìˆë„ë¡ ì¥ê³  í”„ë¡œì íŠ¸ì— ì„¤ì •

certifië¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìœ¼ë©´ ì„¤ì¹˜ í›„

settings.py ìµœìƒë‹¨ì— ì„¤ì •

import os
import certifi
os.environ['SSL_CERT_FILE'] = certifi.where()

-----------
  ë°°í¬í•˜ê¸°
-----------
https://www.notion.so/7-1c2caf5650aa806ba040f5af5cf08ce4

EC2, S3, IAM ìƒì„±

.env ì‘ì„±í•˜ê¸°
ê°’ì´ë‘ ì£¼ì„ì´ë‘ ê°™ì€ ì¤„ì— ìˆìœ¼ë©´ ì£¼ì„ë„ ê°™ì´ ê°’ìœ¼ë¡œ ì¸ì‹
ê³µë°±ë„ ìˆìœ¼ë©´ ì•ˆë¨
# IAM í‚¤ (ë‹¤ìš´ë°›ì€ csv íŒŒì¼ì—ì„œ í™•ì¸)
S3_ACCESS_KEY=ìƒì„±í•œ ì•¡ì„¸ìŠ¤ í‚¤
S3_SECRET_ACCESS_KEY=ìƒì„±í•œ ë¹„ë°€ ì•¡ì„¸ìŠ¤ í‚¤

# S3 ë²„í‚· ì„¤ì •
S3_STORAGE_BUCKET_NAME=ë³¸ì¸ ë²„í‚· ì´ë¦„
S3_REGION_NAME=ap-northeast-2

django-storages, boto3 ì„¤ì¹˜
poetry add django-storages boto3

- `django-storages`: static, media ê°™ì€ íŒŒì¼ì„ ì €ì¥ì†Œì™€ ì—°ê²°í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
- `boto3`: AWS ì— pythonì„ ì´ìš©í•´ì„œ ì—‘ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

# settings.pyì— ì¶”ê°€

# INSTALLED_APPSì— storages ì¶”ê°€
INSTALLED_APPS = [
  	...
    "storages",
]

# Static, Media URL ìˆ˜ì •
STATIC_URL = f'https://{os.getenv("S3_STORAGE_BUCKET_NAME", "django-mini-project")}.s3.amazonaws.com/static/'
MEDIA_URL = f'https://{os.getenv("S3_STORAGE_BUCKET_NAME", "django-mini-project")}.s3.amazonaws.com/media/'

# STORAGES ì‘ì„±
STORAGES = {
    "default": {
        "BACKEND": "storages.backends.s3.S3Storage",
        "OPTIONS": {
            "access_key": os.getenv("S3_ACCESS_KEY", ""),
            "secret_key": os.getenv("S3_SECRET_ACCESS_KEY", ""),
            "bucket_name": os.getenv("S3_STORAGE_BUCKET_NAME", ""),
            "region_name": os.getenv("S3_REGION_NAME", ""),
            "location": "media",
            "default_acl": "public-read",
        },
    },
    "staticfiles": {
        "BACKEND": "storages.backends.s3.S3Storage",
        "OPTIONS": {
            "access_key": os.getenv("S3_ACCESS_KEY", ""),
            "secret_key": os.getenv("S3_SECRET_ACCESS_KEY", ""),
            "bucket_name": os.getenv("S3_STORAGE_BUCKET_NAME", ""),
            "region_name": os.getenv("S3_REGION_NAME", ""),
            "custom_domain": f'{os.getenv("S3_STORAGE_BUCKET_NAME", "")}.s3.amazonaws.com',
            "location": "static",
            "default_acl": "public-read",
        },
    },
}

--------------------------
# S3ì— static íŒŒì¼ ì—…ë¡œë“œ í•˜ê¸°
--------------------------

python-dotenv ì„¤ì¹˜
poetry add python-dotenv

settings.pyì— ì„¤ì •
from dotenv import load_dotenv
load_dotenv(BASE_DIR / '.env')  # .env íŒŒì¼ ë¡œë“œ

# S3ì— static íŒŒì¼ ì—…ë¡œë“œ
python3 manage.py collectstatic

--------------
RDS ìƒì„± ë° ì„¤ì •
--------------

RDSìƒì„±

.envì— DATABASES ì •ë³´ ì…ë ¥

settings.py(prod.py)ì— ì„¤ì •
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.getenv("DB_NAME"),              # ìƒì„±í•œ DB ì´ë¦„
        'USER': os.getenv("DB_USER"),              # PostgreSQL ì‚¬ìš©ì
        'PASSWORD': os.getenv("DB_PASSWORD"),      # ë¹„ë°€ë²ˆí˜¸
        'HOST': os.getenv("DB_HOST"),              # ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì¤‘ì´ë¯€ë¡œ localhost
        'PORT': os.getenv("DB_PORT", "5432"),      # RDS ì—”ë“œí¬ì¸íŠ¸
    }
}

ec2 ì ‘ì†
ssh -i í‚¤/í˜ì–´/ì €ì¥/ìœ„ì¹˜/mp-key.pem ubuntu@EC2_PUBLIC_IP

--------------------------
# Docker ì„¸íŒ…
--------------------------

ì‘ì„±í•œ Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œ
docker build -t django .

ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -p 8000:8000 --env-file .env django

Dockerfile ìƒì„±
# ë² ì´ìŠ¤ ì´ë¯¸ì§€ (ë³¸ì¸ í”„ë¡œì íŠ¸ì— ë§ëŠ” ë²„ì „ ê¸°ì…)
FROM python:3.12-slim

ENV PYTHONUNBUFFERED 1
ENV PYTHONDONTWRITEBYTECODE 1

# ì¢…ì†ì„± íŒŒì¼ ë³µì‚¬
COPY ./poetry.lock /mini_project/
COPY ./pyproject.toml /mini_project/

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /mini_project

# ì¢…ì†ì„± ì„¤ì¹˜
RUN pip3 install poetry
RUN poetry config virtualenvs.create false
RUN poetry install
RUN poetry add gunicorn

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY ./app /mini_project/app
WORKDIR /mini_project/app


# ì†Œì¼“ íŒŒì¼ ìƒì„± ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
RUN mkdir -p /mini_project && chmod -R 755 /mini_project

# Gunicornì„ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "2"]

ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

scripts/run.sh ìƒì„±
mkdir -p scripts
touch scripts/run.sh

ë„ì»¤ ë¹Œë“œ
docker build -t django .

ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
docker run -p 8000:8000 --env-file .env django

ì‹¤í–‰ì¤‘ì¸ ë„ì»¤ í™•ì¸
docker ps

ì»¨í…Œì´ë„ˆ ì¤‘ì§€
docker stop <ì»¨í…Œì´ë„ˆID ë˜ëŠ” ì´ë¦„>



- ğŸ”–Â **mission_1 : ì‘ì„± ë‚´ìš© GitHub ë“±ë¡**
    1. ìƒˆë¡œ ì‘ì„±í•œ `Dockerfile`, `run.sh` íŒŒì¼ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ íŒŒì¼ë“¤ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤.

        ```bash
        # Django í”„ë¡œì íŠ¸ ì½”ë“œë¥¼ app í´ë”ë¡œ í•©ì¹œê²½ìš°
        git add app

        # ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„±
        git commit -m "AWS ì—°ê²° ì™„ë£Œ"

        # ì—…ë¡œë“œ
        git push origin <ê°œë°œ ë¸Œëœì¹˜>
        ```

    2. ë°°í¬ìš© ë¸Œëœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ì„ íƒ)

        ```bash
        # ë¸Œëœì¹˜ ìƒì„±
        git branch release

        # ë¸Œëœì¹˜ ë³€ê²½
        git switch release
        ```

    3. í•´ë‹¹ ë¸Œëœì¹˜ì— ë‚˜ë¨¸ì§€ íŒŒì¼(`Dockerfile`, `run.sh` ë“±) ì—…ë¡œë“œí•©ë‹ˆë‹¤.

        > ë”°ë¡œ ë°°í¬ìš© ë¸Œëœì¹˜ë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤ë©´ main ë˜ëŠ” devë¸Œëœì¹˜ì— ì—…ë¡œë“œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
        >

        ```bash
        # ì—…ë¡œë“œí•  íŒŒì¼ ì¶”ê°€
        git add .

        # ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„±
        git commit -m "Docker ì‘ì„± ì™„ë£Œ"

        # ì—…ë¡œë“œ
        git push origin release
        ```

- ğŸ”–Â **mission_2 : EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ê°€ì ¸ì˜¤ê¸°**
    - Git ì„¤ì¹˜

        ```bash
        # APT ì €ì¥ì†Œ ìµœì‹ í™”
        sudo apt-get update

        # Git ì„¤ì¹˜
        sudo apt-get install git
        ```

    1. ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•´ì¤ë‹ˆë‹¤. (ì ‘ì† ë°©ë²•ì€ ìƒë‹¨ AWS EC2 ë¶€ë¶„ì„ ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤!)
    2. GitHub ë¦¬í¬ì§€í† ë¦¬ì˜ `release` ë¸Œëœì¹˜ë¥¼ í´ë¡ (clone) í•©ë‹ˆë‹¤.

        ```bash
        git clone -b release <repository url>
        ```

        - `-b release`: `release` ë¸Œëœì¹˜ ë‚´ìš©ì„ í´ë¡ í•©ë‹ˆë‹¤.
- ğŸ”–Â **mission_3 : `.env` íŒŒì¼ ì‘ì„±**
    1. í´ë” ì´ë™ ë° `.env` íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.

        ```bash
        # í´ë¡  ë°›ì€ í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
        cd mini_project

        # .env íŒŒì¼ ìƒì„±
        vim .env
        ```

    2. .env íŒŒì¼ ë‚´ìš© ë³µì‚¬í•´ì„œ ë„£ê¸°



- ğŸ”–Â **mission_4 : Docker ë¹Œë“œ ë° ì‹¤í–‰**

    > ì„¤ì¹˜ë¥¼ ì œì™¸í•œ 1~3ë²ˆ ê¹Œì§€ëŠ” ë¡œì»¬ì—ì„œ ì§„í–‰í•œ ë°©ì‹ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
    >
    - **Docker ì„¤ì¹˜**

        > ë§Œì•½ ì´ì „ì— Dockerë¥¼ ì„¤ì¹˜í–ˆë‹¤ê°€ ì‹¤íŒ¨ í•˜ì…¨ë‹¤ë©´ ë¨¼ì € ì œê±° í›„ ì§„í–‰í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
        `for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do sudo apt-get remove $pkg; done`
        >

        ```bash
        # í•„ìš”í•œ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ë° Docker official GPG key ë“±ë¡
        sudo apt-get update
        sudo apt-get install ca-certificates curl
        sudo install -m 0755 -d /etc/apt/keyrings
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        sudo chmod a+r /etc/apt/keyrings/docker.asc

        # APT ì†ŒìŠ¤ íŒŒì¼ì— ë„ì»¤ ì €ì¥ì†Œ ì—°ê²° (ì „ì²´ë¥¼ í•œë²ˆì— ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.)
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

        # ì—°ê²° í›„ ì €ì¥ì†Œ ìƒˆë¡œê³ ì¹¨
        sudo apt-get update

        # Docker ì„¤ì¹˜
        sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

        # ì„¤ì¹˜ í™•ì¸
        docker --version
        ```

    - **docker ê·¸ë£¹ì— ì‚¬ìš©ì ì¶”ê°€í•˜ëŠ” ë°©ë²•**
        1. ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ docker ê·¸ë£¹ì— ì‚¬ìš©ìë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

            ```bash
            # docker gorupd ì— user ì¶”ê°€
            sudo usermod -aG docker $USER

            # groupì— ì¶”ê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸
            groups $USER
            # ê²°ê³¼> ubuntu : ubuntu adm cdrom sudo dip lxd docker
            ```

            - `$USER`: í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë¦„ì„ ìë™ìœ¼ë¡œ ì°¸ì¡°í•©ë‹ˆë‹¤.
            - `usermod -aG`: ì‚¬ìš©ìë¥¼ ì§€ì •ëœ ê·¸ë£¹ì— ì¶”ê°€í•©ë‹ˆë‹¤.
        2. ì¢…ë£Œ í›„ ì¬ì ‘ì†í•˜ê±°ë‚˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ë³€ê²½ ì‚¬í•­ì„ ì¦‰ì‹œ ì ìš©í•©ë‹ˆë‹¤.

            ```bash
            newgrp docker
            ```

            - ë§Œì•½ docker ëª…ë ¹ì–´ê°€ ì—¬ì „íˆ sudo ì—†ì´ ì•ˆëœë‹¤ë©´ ì¢…ë£Œí›„ ì¬ì ‘ì† í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
    1. Docker ë¹Œë“œë¥¼ ìœ„í•´ `Dockerfile`ì´ ìˆëŠ” ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤. (í”„ë¡œì íŠ¸ ë£¨íŠ¸ í´ë”)
    2. Docker ë¹Œë“œë¥¼ ì§„í–‰í•´ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    3. ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ Docker ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    4. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë³´ì•ˆê·¸ë£¹ ê·œì¹™ì— 8000í¬íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        - ì‘ì—…ì¤‘ì¸ EC2ì˜ ë³´ì•ˆê·¸ë£¹ìœ¼ë¡œ ì´ë™í•´ì¤ë‹ˆë‹¤.

            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/00feaf78-d356-41ee-90f9-616e7f73fd77/0445c283-0ff0-472f-bc43-394b343182fc/image.png)

        - ì¸ë°”ìš´ë“œ ê·œì¹™ì„ í¸ì§‘ì„ í´ë¦­í•©ë‹ˆë‹¤.

            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/00feaf78-d356-41ee-90f9-616e7f73fd77/eafd1106-fb90-4839-bdca-23e14a5f6d18/image.png)

        - 8000í¬íŠ¸ë¥¼ ì¶”ê°€í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.

            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/00feaf78-d356-41ee-90f9-616e7f73fd77/7a529c27-042c-496c-9b3c-d8c3c79f6b37/image.png)

    5. APIë¡œ ì ‘ê·¼í•´ì„œ ì ìš©ì´ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        - host ë¶€ë¶„ì€ EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ í¼ë¸”ë¦­ ì•„ì´í”¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/00feaf78-d356-41ee-90f9-616e7f73fd77/5ff341f1-a93f-44e6-85ac-ca4b118950be/image.png)

        - ë¸Œë¼ìš°ì € ë˜ëŠ” Postmanì„ í™œìš©í•´ì„œ APIì— ì ‘ê·¼ì´ ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/00feaf78-d356-41ee-90f9-616e7f73fd77/156a9707-0dd8-4c97-a066-426cf698d51e/image.png)

- ğŸ”–Â **mission_5 : ë°±ê·¸ë¼ìš´ë“œ ëª¨ë“œë¡œ Docker ì‹¤í–‰**

    ```bash
    sudo docker run -p 8000:8000 -d --env-file .env django
    ```

    - `-d` ì˜µì…˜ì„ ì‚¬ìš©í•´ Dockerë¥¼ ë°±ê·¸ë¼ìš´ë“œ ëª¨ë“œë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.